<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Parallel execution using ParallelLogger • ParallelLogger</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Parallel execution using ParallelLogger">
<meta property="og:description" content="ParallelLogger">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ParallelLogger</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">3.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Logging.html">Logging using ParallelLogger</a>
    </li>
    <li>
      <a href="../articles/Parallel.html">Parallel execution using ParallelLogger</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://ohdsi.github.io/Hades" class="external-link"><img src='https://ohdsi.github.io/Hades/images/hadesMini.png' width=80 height=17 style='vertical-align: top;'></a>
</li>
<li>
  <a href="https://github.com/OHDSI/ParallelLogger/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Parallel execution using ParallelLogger</h1>
                        <h4 data-toc-skip class="author">Martijn J.
Schuemie</h4>
            
            <h4 data-toc-skip class="date">2022-12-08</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/OHDSI/ParallelLogger/blob/HEAD/vignettes/Parallel.Rmd" class="external-link"><code>vignettes/Parallel.Rmd</code></a></small>
      <div class="hidden name"><code>Parallel.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette describes how you can use the
<code>ParallelLogger</code> package to execute R code in parallel. This
can help speed up an analysis, by using multiple processors at the same
time instead of using a single processor to execute the code in
sequence.</p>
<div class="section level3">
<h3 id="important-concepts-">Important concepts.<a class="anchor" aria-label="anchor" href="#important-concepts-"></a>
</h3>
<ul>
<li>
<strong>Cluster</strong>: A set of compute nodes.</li>
<li>
<strong>Node</strong>: A separate instance of R that is
instantiated, controlled, and terminated by the user’s current R
session.</li>
</ul>
<p>In this package, all nodes are on the same computer. Note that the
<code>parallel</code> package allows you to also create nodes on remote
machines, for example in a physical computer cluster.</p>
</div>
</div>
<div class="section level2">
<h2 id="creating-a-cluster">Creating a cluster<a class="anchor" aria-label="anchor" href="#creating-a-cluster"></a>
</h2>
<p>We can create a cluster using the <code>makeCluster</code>
command:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cluster</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/makeCluster.html">makeCluster</a></span><span class="op">(</span>numberOfThreads <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Currently in a tryCatch or withCallingHandlers block, so unable to add global calling handlers. ParallelLogger will not capture R messages, errors, and warnings, only explicit calls to ParallelLogger. (This message will not be shown again this R session)</span></span></code></pre>
<p>This instantiates three new R instances on your computer, which
together form a cluster.</p>
<div class="section level3">
<h3 id="singleNode">Single-node cluster<a class="anchor" aria-label="anchor" href="#singleNode"></a>
</h3>
<p>Note that if we set <code>numberOfThreads = 1</code>, the default
behavior is to not instantiate any nodes. Rather, the main thread (the
user’s session) is used for execution. One advantage of this is that it
is easier to debug code in the main thread, as it is possible for
example to set break points or tag a function using <code>debug</code>,
which is not possible when using multiple threads. To disable this
behavior, you can set <code>singleThreadToMain = FALSE</code>.</p>
</div>
</div>
<div class="section level2">
<h2 id="executing-in-parallel">Executing in parallel<a class="anchor" aria-label="anchor" href="#executing-in-parallel"></a>
</h2>
<p>Any code that we want to execute needs to be implemented in an R
function, for example:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">constant</span><span class="op">)</span> <span class="op">{</span></span>
<span>     <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">x</span> <span class="op">*</span> <span class="va">constant</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This simple function merely computes the product of <code>x</code>
and <code>constant</code>, and returns it.</p>
<p>We can now execute this function in parallel across our cluster:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span></span>
<span><span class="fu"><a href="../reference/clusterApply.html">clusterApply</a></span><span class="op">(</span><span class="va">cluster</span>, <span class="va">x</span>, <span class="va">fun</span>, constant <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |=======================                                               |  33%
  |                                                                            
  |===============================================                       |  67%
  |                                                                            
  |======================================================================| 100%</code></pre>
<pre><code><span><span class="co">## [[1]]</span></span>
<span><span class="co">## [1] 2</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[2]]</span></span>
<span><span class="co">## [1] 4</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[3]]</span></span>
<span><span class="co">## [1] 6</span></span></code></pre>
<p>The function <code>clusterApply</code> executes the function across
the nodes over all values of x, and returns all responses in a list.
Note that by default a progress bar is shown. This can be disabled by
setting <code>progressBar = FALSE</code> when calling
<code>clusterApply</code>.</p>
<p><strong>Important</strong>: <code>clusterApply</code> does not
guarantee that the results are returned in the same sequence as
<code>x</code>.</p>
<p><strong>Important</strong>: The context in which a function is
created is also transmitted to the worker node. If a function is defined
inside another function, and that outer function is called with a large
argument, that argument will be transmitted to the worker node each time
the function is executed, causing substantial (probably unnecessary)
overhead. It can therefore make sense to define the function to be
called at the package level rather than inside a function, to save
overhead. So for example, in the code below every time the function
<code>doTinyJob</code> is called, the <code>largeVector</code> argument
is passed to the worker node:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">doBigJob</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">largeVector</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">doTinyJob</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">cluster</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/makeCluster.html">makeCluster</a></span><span class="op">(</span>numberOfThreads <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/clusterApply.html">clusterApply</a></span><span class="op">(</span><span class="va">cluster</span>, <span class="va">largeVector</span>, <span class="va">doTinyJob</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/stopCluster.html">stopCluster</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>It is much more efficient to declare <code>doTinyJob</code> outside
the <code>doBigJob</code> function:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">doTinyJob</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">doBigJob</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">largeVector</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">cluster</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/makeCluster.html">makeCluster</a></span><span class="op">(</span>numberOfThreads <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/clusterApply.html">clusterApply</a></span><span class="op">(</span><span class="va">cluster</span>, <span class="va">largeVector</span>, <span class="va">doTinyJob</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/stopCluster.html">stopCluster</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="stopping-the-cluster">Stopping the cluster<a class="anchor" aria-label="anchor" href="#stopping-the-cluster"></a>
</h2>
<p>Once you are done using the cluster, make sure to stop it:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/stopCluster.html">stopCluster</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="debugging-logging-and-error-handling">Debugging, logging, and error handling<a class="anchor" aria-label="anchor" href="#debugging-logging-and-error-handling"></a>
</h2>
<p>As mentioned in the <a href="#singleNode">Single-node cluster
section</a>, R’s standard debugging tools do not work when executing in
parallel. Setting <code>numberOfThreads = 1</code> when calling
<code>makeCluster</code> ensures the code is executed in the main
thread, so breakpoints and debugging function properly.</p>
<p>The <em>Logging using ParallelLogger</em> vignette explains how
logging can be used to record events, including warnings and errors,
when executing in parallel.</p>
<p>By default, an error thrown by a node does not cause the execution in
the other nodes to stop. Instead, when an error is thrown the execution
continues over the other values, and not until those are complete is an
error thrown in the main thread. The rationale for this is that it might
be informative to see all errors instead of just the first. However,
this behavior can be changed by setting <code>stopOnError = TRUE</code>
when calling <code>clusterApply</code>.</p>
</div>
<div class="section level2">
<h2 id="support-for-andromeda-objects">Support for Andromeda objects<a class="anchor" aria-label="anchor" href="#support-for-andromeda-objects"></a>
</h2>
<p>The <code>Andromeda</code> package allows the user to work with data
objects that are too large to fit in memory, by storing the data on
disk. When calling <code>makeCluster</code>, the
<code>andromedaTempFolder</code> option is copied from the main thread
to all worker nodes. Note that it is not possible to pass Andromeda
objects to nodes. A workaround could be to pass the file name of an
Andromeda object instead.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Martijn Schuemie, Marc Suchard.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
